   <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†Ú† | Ø¨Ø§Ø²ÛŒ Ú¯Ø±ÙˆÙ‡ÛŒ Ù†ÙˆØ³ØªØ§Ù„Ú˜ÛŒÚ©</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Vazir', system-ui, -apple-system, sans-serif;
            background: linear-gradient(145deg, #1e3c4f 0%, #2b5c6f 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px;
            touch-action: manipulation;
        }

        .game-container {
            max-width: 500px;
            width: 100%;
            background: #2a4e5e;
            border-radius: 40px;
            padding: 16px 12px;
            box-shadow: 0 20px 30px rgba(0,0,0,0.5);
            border: 2px solid #ffd966;
        }

        .game-title {
            text-align: center;
            color: #ffd966;
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 3px 3px 0 #b4652a;
        }

        /* Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§Ø²ÛŒÚ©Ù† */
        .player-selector {
            background: #213743;
            padding: 15px;
            border-radius: 30px;
            margin-bottom: 15px;
            border: 2px solid #5f9db2;
        }

        .player-selector label {
            display: block;
            text-align: center;
            color: #ffd966;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .player-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .player-count-btn {
            background: #3a5a6b;
            border: none;
            color: white;
            padding: 12px 0;
            border-radius: 30px;
            flex: 1;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid #7fa9b8;
            transition: 0.2s;
        }

        .player-count-btn.active {
            background: #52b9d1;
            transform: scale(1.02);
            border-color: #ffd966;
            box-shadow: 0 3px 0 #217a94;
        }

        .start-game-btn {
            background: #ffb347;
            border: none;
            color: #1e2f3a;
            font-weight: bold;
            padding: 14px;
            border-radius: 40px;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 0 #a8651e;
            transition: 0.1s;
            width: 100%;
        }

        .start-game-btn:active {
            transform: translateY(5px);
            box-shadow: none;
        }

        /* ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²ÛŒ */
        .game-status {
            background: #213743;
            border-radius: 30px;
            padding: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #5f9db2;
        }

        .turn-indicator {
            background: #52b9d1;
            padding: 8px 18px;
            border-radius: 40px;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            border: 2px solid #ffd966;
        }

        .dice-value {
            background: #3a5a6b;
            padding: 8px 18px;
            border-radius: 40px;
            color: white;
            font-size: 1.3rem;
            border: 2px solid #ffb347;
        }

        /* ========== ØµÙØ­Ù‡ Ù…Ù†Ú† Ø§ØµÙ„ÛŒ ========== */
        .mench-board {
            background: #ecd8b4;
            border-radius: 30px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            gap: 3px;
            aspect-ratio: 1 / 1;
            width: 100%;
            border: 4px solid #aa8e6c;
            box-shadow: inset 0 0 0 3px #8b6f4c;
            margin-bottom: 15px;
        }

        /* Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡ */
        .cell {
            aspect-ratio: 1 / 1;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            position: relative;
            box-shadow: 0 2px 0 #8b6f4c;
            font-size: 0.8rem;
        }

        /* Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø³ÛŒØ± Ø§ØµÙ„ÛŒ */
        .cell.path-red { background: #ffb3b3; }
        .cell.path-blue { background: #b3d9ff; }
        .cell.path-green { background: #c1f0c1; }
        .cell.path-yellow { background: #fff5b3; }

        /* Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ø±ÙˆØ¹ (Ù…Ø­Ù„ Ù…Ù‡Ø±Ù‡â€ŒÙ‡Ø§) */
        .cell.home-red { background: #ff0000; }
        .cell.home-blue { background: #0000ff; }
        .cell.home-green { background: #00aa00; }
        .cell.home-yellow { background: #ffcc00; }

        /* Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªÙ‡Ø§ÛŒÛŒ */
        .cell.finish-red { background: #ff6666; border: 2px solid red; }
        .cell.finish-blue { background: #6666ff; border: 2px solid blue; }
        .cell.finish-green { background: #66cc66; border: 2px solid green; }
        .cell.finish-yellow { background: #ffdd66; border: 2px solid goldenrod; }

        /* Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù† (Ø³ØªØ§Ø±Ù‡â€ŒØ¯Ø§Ø±) */
        .cell.safe {
            border: 3px solid gold;
            box-shadow: 0 0 15px gold;
            z-index: 2;
        }

        /* Ù…Ù‡Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ */
        .piece {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 0 black;
            margin: 1px;
            font-size: 0.8rem;
            box-shadow: 0 3px 0 rgba(0,0,0,0.4);
            border: 1px solid white;
        }

        .piece.red { background: #cc0000; }
        .piece.blue { background: #0000cc; }
        .piece.green { background: #008800; }
        .piece.yellow { background: #b8860b; color: white; }

        /* Ø¨Ø®Ø´ ØªØ§Ø³ */
        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #1d3e4b;
            padding: 12px;
            border-radius: 60px;
            border: 3px solid #ffb347;
            margin-bottom: 8px;
        }

        .dice-box {
            background: white;
            border-radius: 25px;
            padding: 5px 15px;
            box-shadow: inset 0 -4px 0 #aaa;
        }

        .dice {
            font-size: 3.2rem;
            line-height: 1;
            min-width: 80px;
            text-align: center;
        }

        .roll-btn {
            background: #52b9d1;
            border: none;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            padding: 16px 20px;
            border-radius: 50px;
            flex: 1;
            cursor: pointer;
            box-shadow: 0 6px 0 #217a94;
            transition: 0.1s;
            border: 2px solid #b5e4f0;
        }

        .roll-btn:active {
            transform: translateY(6px);
            box-shadow: none;
        }

        .roll-btn:disabled {
            opacity: 0.5;
            transform: translateY(0);
            box-shadow: 0 4px 0 #217a94;
        }

        .game-message {
            background: #152d36;
            color: #cbe7f1;
            padding: 12px;
            border-radius: 40px;
            text-align: center;
            font-size: 1rem;
            border: 2px solid #ffb347;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">ğŸ² Ù…Ù†Ú† ğŸ²</h1>

        <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§Ø²ÛŒÚ©Ù† -->
        <div class="player-selector" id="playerSelector">
            <label>ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†:</label>
            <div class="player-buttons">
                <button class="player-count-btn active" data-count="2">Û² Ù†ÙØ±</button>
                <button class="player-count-btn" data-count="3">Û³ Ù†ÙØ±</button>
                <button class="player-count-btn" data-count="4">Û´ Ù†ÙØ±</button>
            </div>
            <button id="startGameBtn" class="start-game-btn">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯</button>
        </div>

        <!-- ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²ÛŒ -->
        <div class="game-status" id="gameStatus" style="display: none;">
            <div class="turn-indicator" id="turnIndicator">ğŸ”´ Ù‚Ø±Ù…Ø²</div>
            <div class="dice-value" id="diceValue">ğŸ² -</div>
        </div>

        <!-- ØµÙØ­Ù‡ Ø¨Ø§Ø²ÛŒ Ù…Ù†Ú† -->
        <div id="board" class="mench-board"></div>

        <!-- Ú©Ù†ØªØ±Ù„ ØªØ§Ø³ -->
        <div class="controls">
            <div class="dice-box">
                <div id="dice" class="dice">ğŸ²</div>
            </div>
            <button id="rollDiceBtn" class="roll-btn">Ù¾Ø±ØªØ§Ø¨ ØªØ§Ø³</button>
        </div>

        <!-- Ù¾ÛŒØ§Ù… Ø¨Ø§Ø²ÛŒ -->
        <div id="gameMessage" class="game-message">ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
    </div>

    <script>
        (function() {
            // ==================== ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØµØ¯Ø§ ====================
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            let audioCtx = null;
            let soundsEnabled = true;

            function initAudio() {
                if (!audioCtx) {
                    audioCtx = new AudioContext();
                }
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
            }

            function playSound(type) {
                if (!soundsEnabled || !audioCtx) return;
                
                const now = audioCtx.currentTime;
                
                switch(type) {
                    case 'dice': {
                        for (let i = 0; i < 3; i++) {
                            const osc = audioCtx.createOscillator();
                            const gain = audioCtx.createGain();
                            osc.connect(gain);
                            gain.connect(audioCtx.destination);
                            osc.frequency.value = 400 + i * 100;
                            gain.gain.value = 0.1;
                            osc.start(now + i * 0.05);
                            gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.05 + 0.1);
                            osc.stop(now + i * 0.05 + 0.1);
                        }
                        break;
                    }
                    case 'move': {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.frequency.value = 600;
                        gain.gain.value = 0.1;
                        osc.start(now);
                        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                        osc.stop(now + 0.1);
                        break;
                    }
                    case 'enter': {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.frequency.setValueAtTime(400, now);
                        osc.frequency.exponentialRampToValueAtTime(800, now + 0.2);
                        gain.gain.value = 0.15;
                        osc.start(now);
                        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                        osc.stop(now + 0.3);
                        break;
                    }
                    case 'eat': {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.frequency.value = 200;
                        gain.gain.value = 0.2;
                        osc.start(now);
                        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                        osc.stop(now + 0.2);
                        break;
                    }
                    case 'win': {
                        const notes = [523, 659, 784, 1046];
                        notes.forEach((freq, i) => {
                            const osc = audioCtx.createOscillator();
                            const gain = audioCtx.createGain();
                            osc.connect(gain);
                            gain.connect(audioCtx.destination);
                            osc.frequency.value = freq;
                            gain.gain.value = 0.15;
                            osc.start(now + i * 0.15);
                            gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.15 + 0.3);
                            osc.stop(now + i * 0.15 + 0.3);
                        });
                        break;
                    }
                }
            }

            // ==================== ØªØ¹Ø±ÛŒÙ Ø³Ø§Ø®ØªØ§Ø± ØµÙØ­Ù‡ Ù…Ù†Ú† ====================
            // Ø§ÛŒÙ† Ø¢Ø±Ø§ÛŒÙ‡ Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ù‡Ø± Ø®Ø§Ù†Ù‡ Ø§Ø² Ú¯Ø±ÛŒØ¯ 15x15 Ú†Ù‡ Ù†ÙˆØ¹ Ø®Ø§Ù†Ù‡â€ŒØ§ÛŒ Ø§Ø³Øª
            const BOARD_LAYOUT = [
                // 0: Ø®Ø§Ù„ÛŒ, 1: Ù…Ø³ÛŒØ± Ù‚Ø±Ù…Ø², 2: Ù…Ø³ÛŒØ± Ø¢Ø¨ÛŒ, 3: Ù…Ø³ÛŒØ± Ø³Ø¨Ø², 4: Ù…Ø³ÛŒØ± Ø²Ø±Ø¯
                // 5: Ø®Ø§Ù†Ù‡ Ù‚Ø±Ù…Ø², 6: Ø®Ø§Ù†Ù‡ Ø¢Ø¨ÛŒ, 7: Ø®Ø§Ù†Ù‡ Ø³Ø¨Ø², 8: Ø®Ø§Ù†Ù‡ Ø²Ø±Ø¯
                // 9: Ù¾Ø§ÛŒØ§Ù† Ù‚Ø±Ù…Ø², 10: Ù¾Ø§ÛŒØ§Ù† Ø¢Ø¨ÛŒ, 11: Ù¾Ø§ÛŒØ§Ù† Ø³Ø¨Ø², 12: Ù¾Ø§ÛŒØ§Ù† Ø²Ø±Ø¯
                // Ø³ØªØ§Ø±Ù‡â€ŒØ¯Ø§Ø±: Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†
                
                /* Ø±Ø¯ÛŒÙ 0 */ [0,0,0,0,0,5,5,5,5,5,0,0,0,0,0],
                /* Ø±Ø¯ÛŒÙ 1 */ [0,0,0,0,0,5,5,5,5,5,0,0,0,0,0],
                /* Ø±Ø¯ÛŒÙ 2 */ [0,0,0,0,0,5,5,5,5,5,0,0,0,0,0],
                /* Ø±Ø¯ÛŒÙ 3 */ [0,0,0,0,0,5,5,5,5,5,0,0,0,0,0],
                /* Ø±Ø¯ÛŒÙ 4 */ [0,0,0,0,0,5,5,5,5,5,0,0,0,0,0],
                /* Ø±Ø¯ÛŒÙ 5 */ [8,8,8,8,8,1,1,1,1,1,2,2,2,2,2],
                /* Ø±Ø¯ÛŒÙ 6 */ [8,8,8,8,8,1,9,9,9,1,2,10,10,10,2],
                /* Ø±Ø¯ÛŒÙ 7 */ [8,8,8,8,8,1,9,9,9,1,2,10,10,10,2],
                /* Ø±Ø¯ÛŒÙ 8 */ [8,8,8,8,8,1,9,9,9,1,2,10,10,10,2],
                /* Ø±Ø¯ÛŒÙ 9 */ [8,8,8,8,8,1,1,1,1,1,2,2,2,2,2],
                /* Ø±Ø¯ÛŒÙ 10*/ [0,0,0,0,0,7,7,7,7,7,0,0,0,0,0],
                /* Ø±Ø¯ÛŒÙ 11*/ [0,0,0,0,0,7,7,7,7,7,0,0,0,0,0],
                /* Ø±Ø¯ÛŒÙ 12*/ [0,0,0,0,0,7,7,7,7,7,0,0,0,0,0],
                /* Ø±Ø¯ÛŒÙ 13*/ [0,0,0,0,0,7,7,7,7,7,0,0,0,0,0],
                /* Ø±Ø¯ÛŒÙ 14*/ [0,0,0,0,0,7,7,7,7,7,0,0,0,0,0]
            ];

            // Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù† (Ø³ØªØ§Ø±Ù‡â€ŒØ¯Ø§Ø±)
            const SAFE_POSITIONS = [
                {row:5, col:5}, {row:5, col:9}, {row:9, col:5}, {row:9, col:9}, // Ú†Ù‡Ø§Ø± Ú¯ÙˆØ´Ù‡ Ù…Ø³ÛŒØ±
                {row:7, col:0}, {row:7, col:14}, {row:0, col:7}, {row:14, col:7} // Ù…Ø±Ú©Ø² Ù‡Ø± Ø¶Ù„Ø¹
            ];

            // Ù…Ø³ÛŒØ± Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø±Ú©Øª (Ø¨Ù‡ ØªØ±ØªÛŒØ¨)
            const MAIN_PATH = [
                {row:5, col:5}, {row:5, col:6}, {row:5, col:7}, {row:5, col:8}, {row:5, col:9},
                {row:6, col:9}, {row:7, col:9}, {row:8, col:9}, {row:9, col:9},
                {row:9, col:8}, {row:9, col:7}, {row:9, col:6}, {row:9, col:5},
                {row:8, col:5}, {row:7, col:5}, {row:6, col:5},
                {row:5, col:5} // Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ø§ÙˆÙ„ (Ø¨Ø±Ø§ÛŒ Ø­Ø±Ú©Øª Ø¯Ø§ÛŒØ±Ù‡â€ŒØ§ÛŒ)
            ];

            // ==================== ØªØ¹Ø±ÛŒÙ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† ====================
            const PLAYERS = [
                { id: 0, name: 'Ù‚Ø±Ù…Ø²', emoji: 'ğŸ”´', color: 'red', homePos: {row:0, col:5}, finishStart: 40 },
                { id: 1, name: 'Ø¢Ø¨ÛŒ', emoji: 'ğŸ”µ', color: 'blue', homePos: {row:5, col:10}, finishStart: 44 },
                { id: 2, name: 'Ø³Ø¨Ø²', emoji: 'ğŸŸ¢', color: 'green', homePos: {row:10, col:5}, finishStart: 48 },
                { id: 3, name: 'Ø²Ø±Ø¯', emoji: 'ğŸŸ¡', color: 'yellow', homePos: {row:5, col:0}, finishStart: 52 }
            ];

            // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ
            let players = [];
            let currentPlayerIndex = 0;
            let gameActive = false;
            let isMoving = false;
            let extraTurn = false;

            // ==================== Ø³Ø§Ø®Øª ØµÙØ­Ù‡ ====================
            function createBoard() {
                const board = document.getElementById('board');
                board.innerHTML = '';
                
                for (let r = 0; r < 15; r++) {
                    for (let c = 0; c < 15; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = r;
                        cell.dataset.col = c;
                        
                        const cellType = BOARD_LAYOUT[r][c];
                        
                        // ØªØ¹ÛŒÛŒÙ† Ú©Ù„Ø§Ø³ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ø®Ø§Ù†Ù‡
                        if (cellType >= 1 && cellType <= 4) {
                            // Ù…Ø³ÛŒØ± Ø§ØµÙ„ÛŒ
                            const colors = ['path-red', 'path-blue', 'path-green', 'path-yellow'];
                            cell.classList.add(colors[cellType-1]);
                        } else if (cellType >= 5 && cellType <= 8) {
                            // Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ø±ÙˆØ¹
                            const homes = ['home-red', 'home-blue', 'home-green', 'home-yellow'];
                            cell.classList.add(homes[cellType-5]);
                        } else if (cellType >= 9 && cellType <= 12) {
                            // Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªÙ‡Ø§ÛŒÛŒ
                            const finishes = ['finish-red', 'finish-blue', 'finish-green', 'finish-yellow'];
                            cell.classList.add(finishes[cellType-9]);
                        }
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†
                        if (SAFE_POSITIONS.some(pos => pos.row === r && pos.col === c)) {
                            cell.classList.add('safe');
                        }
                        
                        board.appendChild(cell);
                    }
                }
            }

            // ==================== Ù†Ù…Ø§ÛŒØ´ Ù…Ù‡Ø±Ù‡â€ŒÙ‡Ø§ ====================
            function updateBoard() {
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ù…Ù‡Ø±Ù‡â€ŒÙ‡Ø§
                document.querySelectorAll('.piece').forEach(p => p.remove());
                
                players.forEach((player, pIdx) => {
                    player.pieces.forEach((piecePos, pieceIdx) => {
                        if (piecePos >= 0) {
                            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø³Ù„ÙˆÙ„ Ù…ØªÙ†Ø§Ø³Ø¨ Ø¨Ø§ Ù…ÙˆÙ‚Ø¹ÛŒØª
                            let cell;
                            if (piecePos < 40) {
                                // Ø¯Ø± Ù…Ø³ÛŒØ± Ø§ØµÙ„ÛŒ
                                const pos = MAIN_PATH[piecePos % MAIN_PATH.length];
                                cell = document.querySelector(`[data-row="${pos.row}"][data-col="${pos.col}"]`);
                            } else {
                                // Ø¯Ø± Ù…Ø³ÛŒØ± Ø§Ù†ØªÙ‡Ø§ÛŒÛŒ
                                const finishIndex = piecePos - player.finishStart;
                                if (finishIndex >= 0 && finishIndex < 4) {
                                    // Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªÙ‡Ø§ÛŒÛŒ Ù‡Ø± Ø¨Ø§Ø²ÛŒÚ©Ù†
                                    // Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø§ÛŒØ¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¨Ø§Ø²ÛŒÚ©Ù† Ùˆ Ø´Ù…Ø§Ø±Ù‡ Ù…Ù‡Ø±Ù‡ ØªÚ©Ù…ÛŒÙ„ Ø´ÙˆØ¯
                                }
                            }
                            
                            if (cell) {
                                const piece = document.createElement('span');
                                piece.className = `piece ${player.color}`;
                                piece.textContent = pieceIdx + 1;
                                piece.dataset.player = pIdx;
                                piece.dataset.piece = pieceIdx;
                                cell.appendChild(piece);
                            }
                        }
                    });
                });
            }

            // ==================== Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯ ====================
            function startNewGame(playerCount) {
                initAudio();
                playSound('enter');
                
                players = [];
                for (let i = 0; i < playerCount; i++) {
                    players.push({
                        ...PLAYERS[i],
                        pieces: [-1, -1, -1, -1] // -1 ÛŒØ¹Ù†ÛŒ Ø¯Ø± Ø®Ø§Ù†Ù‡
                    });
                }
                
                currentPlayerIndex = 0;
                gameActive = true;
                isMoving = false;
                extraTurn = false;
                
                document.getElementById('playerSelector').style.display = 'none';
                document.getElementById('gameStatus').style.display = 'flex';
                document.getElementById('dice').textContent = 'ğŸ²';
                document.getElementById('diceValue').textContent = 'ğŸ² -';
                document.getElementById('turnIndicator').innerHTML = `${players[0].emoji} ${players[0].name}`;
                document.getElementById('gameMessage').textContent = `${players[0].emoji} ØªØ§Ø³ Ø¨Ù†Ø¯Ø§Ø² ØªØ§ Ù…Ù‡Ø±Ù‡ Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒ`;
                
                updateBoard();
                document.getElementById('rollDiceBtn').disabled = false;
            }

            // ==================== Ù¾Ø±ØªØ§Ø¨ ØªØ§Ø³ ====================
            async function handleRoll() {
                if (!gameActive || isMoving) return;
                
                isMoving = true;
                document.getElementById('rollDiceBtn').disabled = true;
                
                playSound('dice');
                
                const diceNumber = Math.floor(Math.random() * 6) + 1;
                await animateDice(diceNumber);
                
                document.getElementById('diceValue').textContent = `ğŸ² ${diceNumber}`;
                
                await processMove(diceNumber);
                
                isMoving = false;
                document.getElementById('rollDiceBtn').disabled = false;
            }

            // ==================== Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ØªØ§Ø³ ====================
            async function animateDice(finalValue) {
                const diceEl = document.getElementById('dice');
                const diceFaces = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'];
                
                for (let i = 0; i < 12; i++) {
                    const randomIndex = Math.floor(Math.random() * 6);
                    diceEl.textContent = diceFaces[randomIndex];
                    await new Promise(r => setTimeout(r, 60));
                }
                
                const diceEmoji = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£'];
                diceEl.textContent = diceEmoji[finalValue - 1];
            }

            // ==================== Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø­Ø±Ú©Øª ====================
            async function processMove(diceNumber) {
                const player = players[currentPlayerIndex];
                
                // Ø§Ú¯Ø± Û¶ Ø¢Ù…Ø¯ Ùˆ Ù…Ù‡Ø±Ù‡ Ø¯Ø± Ø®Ø§Ù†Ù‡ Ø¯Ø§Ø±ÛŒÙ…
                if (diceNumber === 6 && player.pieces.some(p => p === -1)) {
                    const pieceIndex = player.pieces.findIndex(p => p === -1);
                    player.pieces[pieceIndex] = 0; // Ø¨Ø°Ø§Ø± Ø±ÙˆÛŒ Ø®Ø§Ù†Ù‡ Ø´Ø±ÙˆØ¹ Ù…Ø³ÛŒØ±
                    playSound('enter');
                    updateBoard();
                    document.getElementById('gameMessage').textContent = 
                        `${player.emoji} Ù…Ù‡Ø±Ù‡ Ø¬Ø¯ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø¨Ø§Ø²ÛŒ Ø´Ø¯!`;
                    extraTurn = true;
                    return;
                }
                
                // Ø­Ø±Ú©Øª Ù…Ù‡Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ Ø¨Ø§Ø²ÛŒ
                const activePieces = player.pieces
                    .map((pos, idx) => ({ pos, idx }))
                    .filter(p => p.pos >= 0 && p.pos < 40);
                
                if (activePieces.length === 0) {
                    document.getElementById('gameMessage').textContent = 
                        `${player.emoji} Ù…Ù‡Ø±Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø±Ú©Øª Ù†Ø¯Ø§Ø±ÛŒ!`;
                    nextTurn();
                    return;
                }
                
                // Ø³Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ: Ø§ÙˆÙ„ÛŒÙ† Ù…Ù‡Ø±Ù‡ Ø±Ùˆ Ø­Ø±Ú©Øª Ø¨Ø¯Ù‡
                const piece = activePieces[0];
                let newPos = piece.pos + diceNumber;
                
                if (newPos >= 40) {
                    // ÙˆØ§Ø±Ø¯ Ù…Ø³ÛŒØ± Ø§Ù†ØªÙ‡Ø§ÛŒÛŒ Ø¨Ø´Ù‡
                    const finishPath = newPos - 40;
                    if (finishPath < 4) {
                        newPos = player.finishStart + finishPath;
                    } else {
                        document.getElementById('gameMessage').textContent = 
                            `${player.emoji} Ø§ÛŒÙ† Ø­Ø±Ú©Øª Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª!`;
                        nextTurn();
                        return;
                    }
                }
                
                // Ø­Ø±Ú©Øª ØªÚ©Ù‡â€ŒØªÚ©Ù‡
                for (let i = piece.pos + 1; i <= newPos; i++) {
                    if (i < 40) {
                        player.pieces[piece.idx] = i;
                    } else {
                        player.pieces[piece.idx] = i;
                    }
                    updateBoard();
                    playSound('move');
                    await new Promise(r => setTimeout(r, 150));
                }
                
                // Ø®ÙˆØ±Ø¯Ù† Ù…Ù‡Ø±Ù‡ Ø­Ø±ÛŒÙ
                checkEating(player, piece.idx, newPos);
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ø¯
                if (player.pieces.every(p => p >= player.finishStart)) {
                    document.getElementById('gameMessage').textContent = 
                        `ğŸ† ${player.emoji} Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯! ğŸ†`;
                    playSound('win');
                    gameActive = false;
                    return;
                }
                
                if (diceNumber === 6) {
                    document.getElementById('gameMessage').textContent = 
                        `${player.emoji} Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªØ§Ø³ Ø¨Ù†Ø¯Ø§Ø² (Û¶ Ø¢ÙˆØ±Ø¯ÛŒ)!`;
                    extraTurn = true;
                } else {
                    nextTurn();
                }
            }

            // ==================== Ø®ÙˆØ±Ø¯Ù† Ù…Ù‡Ø±Ù‡ Ø­Ø±ÛŒÙ ====================
            function checkEating(currentPlayer, pieceIdx, newPos) {
                // Ø§Ú¯Ø± Ø¯Ø± Ø®Ø§Ù†Ù‡ Ø§Ù…Ù† Ù‡Ø³ØªØŒ Ù†Ø®ÙˆØ±
                const cell = document.querySelector(`[data-row="${MAIN_PATH[newPos]?.row}"][data-col="${MAIN_PATH[newPos]?.col}"]`);
                if (cell && cell.classList.contains('safe')) return;
                
                players.forEach((player, pIdx) => {
                    if (pIdx !== currentPlayerIndex) {
                        player.pieces.forEach((pos, idx) => {
                            if (pos === newPos && newPos < 40) {
                                player.pieces[idx] = -1; // Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡
                                playSound('eat');
                                document.getElementById('gameMessage').textContent = 
                                    `ğŸ¯ ${currentPlayer.emoji} Ù…Ù‡Ø±Ù‡ ${player.emoji} Ø±Ùˆ Ø®ÙˆØ±Ø¯!`;
                            }
                        });
                    }
                });
                updateBoard();
            }

            // ==================== Ù†ÙˆØ¨Øª Ø¨Ø¹Ø¯ÛŒ ====================
            function nextTurn() {
                do {
                    currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
                } while (players[currentPlayerIndex].pieces.every(p => p >= 40) && 
                         players.some(p => !p.pieces.every(p => p >= 40)));
                
                document.getElementById('turnIndicator').innerHTML = 
                    `${players[currentPlayerIndex].emoji} ${players[currentPlayerIndex].name}`;
                document.getElementById('gameMessage').textContent = 
                    `${players[currentPlayerIndex].emoji} Ù†ÙˆØ¨Øª ØªÙˆØ¦Ù‡`;
                extraTurn = false;
            }

            // ==================== Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ====================
            document.addEventListener('DOMContentLoaded', () => {
                createBoard();
                
                // Ø§Ù†ØªØ®Ø§Ø¨ ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†
                document.querySelectorAll('.player-count-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.player-count-btn').forEach(b => 
                            b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
                
                // Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
                document.getElementById('startGameBtn').addEventListener('click', () => {
                    const activeBtn = document.querySelector('.player-count-btn.active');
                    const count = parseInt(activeBtn.dataset.count);
                    startNewGame(count);
                });
                
                // Ø¯Ú©Ù…Ù‡ ØªØ§Ø³
                document.getElementById('rollDiceBtn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleRoll();
                });
                
                // ØªØ§Ú† Ø±ÙˆÛŒ ØµÙØ­Ù‡ Ø¨Ø§Ø²ÛŒ
                document.getElementById('board').addEventListener('click', (e) => {
                    if (gameActive && !isMoving) {
                        handleRoll();
                    }
                });
                
                document.getElementById('board').addEventListener('touchstart', (e) => {
                    if (gameActive && !isMoving) {
                        e.preventDefault();
                        handleRoll();
                    }
                });
            });
        })();
    </script>
</body>
</html>           
